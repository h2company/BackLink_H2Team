<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />



</head>
<body>
	<script src="ajax/libs/sockjs-client/sockjs.min.js"></script>
	<script src="ajax/libs/stompjs/stomp.min.js"></script>
	<script>
		var stompClient = null;
		var siteId = null;
        function bindEvent(element, eventName, eventHandler) {
            if (element.addEventListener) {
                element.addEventListener(eventName, eventHandler, false);
            } else if (element.attachEvent) {
                element.attachEvent('on' + eventName, eventHandler);
            }
        }
        bindEvent(window, 'message', function (e) {
        	if(e.data.action == 'connect'){
        		console.log('Begin listen !');
                window.blSiteSettings = e.data.blSiteSettings;
        		connect();
        	} else if(e.data.action == 'tracking'){
        		e.data.type = "tracking";
        		window.blSiteSettings = e.data.blSiteSettings;
        		if(stompClient && e.data.isTrusted == true) {
        			delete e.data.isTrusted;
        			stompClient.send("/app/service.sendMessage", {}, JSON.stringify(e.data));
        		}
        	}
        });
		function connect() {
			siteId = window.blSiteSettings.site_id ? window.blSiteSettings.site_id : new URL(window.location.href).searchParams.get("auth_token");
			if (siteId) {

				var socket = new SockJS('/ws');
				stompClient = Stomp.over(socket);

				stompClient.connect({}, onConnected, onError);
			}
		}
		function onConnected() {
			stompClient.subscribe('/service/public', onMessageReceived);

			stompClient.send("/app/service.addEvent", {}, JSON.stringify({
				action: 'tracking',
				siteId : siteId,
				type : 'CONNECT'
			}))
		}
		function onMessageReceived(payload) {
			var message = JSON.parse(payload.body);

			if (message.type === 'CONNECT') {
				console.log("CONNECT", message);
			} else if (message.type === 'LEAVE') {
				console.log("LEAVE", message);
			} else {
				console.log("RESPONE", message);
			}
		}
		function onError(error) {
		    console.log('Could not connect to WebSocket server. Please refresh this page to try again!');
		}
	</script>
</body>
</html>